<form [formGroup]="pipelineForm" (ngSubmit)="submit()" xmlns="http://www.w3.org/1999/html">
    <!-- Name -->
    <div class="form-group">
        <!-- name -->
        <label for="name">Name</label>
        <input formControlName="name" type="text"
               class="form-control {{name?.invalid && (name?.dirty || name?.touched) && 'is-invalid'}}" id="name"
               placeholder="My pipeline">
        <small fzColor textColor="danger" *ngIf="name?.invalid && (name?.dirty || name?.touched)">
            Required
        </small>
    </div>

    <!-- pipeline outputs -->
    <!-- this isn't extracted to a component for two reasons, one because I couldn't figure out the form nesting, and two because I wasn't sure how to share the outputs data, so each component was making network calls when it didn't need to. -->
    <div class="form-group">
        <label for="outputs" fzTip
               content="Messages that pass all required steps will be sent to the selected outputs"
               animation="shift-away">Pipeline outputs</label>
        <p-multiSelect
                id="outputs"
                [options]="outputs"
                formControlName="outputs"
                defaultLabel="Outputs"
                optionLabel="name"
                optionValue="id"
                selectedItemsLabel="{0} items selected"
                display="chip"
                class="fullwidth"
        >
        </p-multiSelect>
        <!--        <app-outputs-selector id="'outputs'" [parentForm]="pipelineForm" fzTip content="Messages that pass all required filters will be sent to these outputs"></app-outputs-selector>-->
    </div>

    <!-- concurrency and retries -->
    <div class="form-group">
        <div class="form-row">
            <!-- max retries -->
            <div class="col">
                <label for="max_retries" fzTip
                       content="The maximum number of times a message should be run through this pipeline"
                       animation="shift-away">Max retries</label>
                <input class="form-control {{max_retries?.invalid && (max_retries?.dirty || max_retries?.touched) && 'is-invalid'}}"
                       formControlName="max_retries" type="number" min="-1" id="max_retries">
                <small fzColor textColor="danger"
                       *ngIf="max_retries?.invalid && (max_retries?.dirty || max_retries?.touched)">
                    Required, must be at least -1
                </small>
            </div>
            <!-- retry interval -->
            <div class="col">
                <label for="retry_interval" fzTip content="How many seconds between retry attempts"
                       animation="shift-away">Retry interval</label>
                <input class="form-control {{retry_interval?.invalid && (retry_interval?.dirty || retry_interval?.touched) && 'is-invalid'}}"
                       formControlName="retry_interval" type="number" min="0" id="retry_interval">
                <small fzColor textColor="danger"
                       *ngIf="retry_interval?.invalid && (retry_interval?.dirty || retry_interval?.touched)">
                    Required, must be at least 0
                </small>
            </div>
        </div>
    </div>
    <!-- steps -->
    <div class="form-group">
        <p><i class="mr-2 fas fa-filter"></i> Steps</p>
        <div #steps class="row mb-3" *ngFor="let step of steps!['controls'];let i=index" formArrayName="steps">
            <fz-card class="col-12">
                <!-- step controls -->
                <!--            <td class="col1 h-100 align-middle justify-content-center">-->
<!--                                <a (click)="moveStepUp(i)" fzTip content="Move filter up" animation="shift-away" class="mr-2" href="javascript:void(0);">-->
<!--                                    <fz-icon-color-circle color="primary" icon="fas fa-arrow-up"></fz-icon-color-circle>-->
<!--                                </a>-->
<!--                                <a (click)="moveStepDown(i)" fzTip content="Move filter down" animation="shift-away" class="mr-2" href="javascript:void(0);">-->
<!--                                    <fz-icon-color-circle color="primary" icon="fas fa-arrow-down"></fz-icon-color-circle>-->
<!--                                </a>-->
<!--                                <a (click)="removeStep(i)" fzTip content="Remove filter" animation="shift-away" href="javascript:void(0);">-->
<!--                                    <fz-icon-color-circle color="danger" icon="fas fa-trash"></fz-icon-color-circle>-->
<!--                                </a>-->
                <!--            </td>-->

                <!-- step form -->
                <div class="form-group" [formGroupName]="i">
                    <!-- step function -->
                    <div class="form-group mt-2">
                        <label for="step-{{i}}-function" fzTip content="The function to run for this step" animation="shift-away">Function</label>
                        <div class="form-control" id="step-{{i}}-function" style="height: 250px;">
                            <ace-editor [aceOptions]="aceOptions" [editorOptions]="editorOptions" [stepType]="step['controls']['type']" [control]="step['controls']['function']" [namey]="i"></ace-editor>
                        </div>
                    </div>
                    <!-- step outputs -->
                    <!-- this isn't extracted to a component for two reasons, one because I couldn't figure out the form nesting, and two because I wasn't sure how to share the outputs data, so each component was making network calls when it didn't need to. -->
                    <div class="form-group">
                        <label for="step-{{i}}-outputs" fzTip
                               content="Messages that pass this step will be sent to the selected outputs"
                               animation="shift-away">Step outputs</label>
                        <p-multiSelect
                                id="step-{{i}}-outputs"
                                [options]="outputs"
                                formControlName="outputs"
                                defaultLabel="Outputs"
                                optionLabel="name"
                                optionValue="id"
                                selectedItemsLabel="{0} items selected"
                                display="chip"
                                class="fullwidth"
                                fzTip
                                content="Select outputs"
                        >
                        </p-multiSelect>
                        <!--                                            <app-outputs-selector id="'step-{{i}}-outputs'" [parentForm]="pipelineForm" [formGroupName]="i" fzTip content="Messages that pass all required filters will be sent to these outputs"></app-outputs-selector>-->
                    </div>

                    <!-- required -->
                    <div class="form-group custom-control custom-switch">
                        <input formControlName="required" type="checkbox" class="custom-control-input"
                               id="step-{{i}}-required">
                        <label class="custom-control-label" for="step-{{i}}-required" fzTip
                               content="This step must be successful in order for messages to be sent to the pipeline's output"
                               animation="shift-away">Required</label>
                    </div>

                    <!-- controls -->
                    <div class="d-flex justify-content-start">
                        <a (click)="moveStepUp(i)" fzTip content="Move step up" animation="shift-away" class="mr-2" href="javascript:void(0);">
                            <fz-icon-color-circle color="primary" icon="fas fa-arrow-up"></fz-icon-color-circle>
                        </a>
                        <a (click)="moveStepDown(i)" fzTip content="Move step down" animation="shift-away" class="mr-2" href="javascript:void(0);">
                            <fz-icon-color-circle color="primary" icon="fas fa-arrow-down"></fz-icon-color-circle>
                        </a>
                        <a (click)="removeStep(i)" fzTip content="Remove step" animation="shift-away" href="javascript:void(0);">
                            <fz-icon-color-circle color="danger" icon="fas fa-trash"></fz-icon-color-circle>
                        </a>
                    </div>
                </div>
            </fz-card>
        </div>
        <!-- footer -->
        <div>
            {{ steps?.value.length | i18nPlural: itemPluralMapping['step']}}
            <button class="ml-2" size="sm" fzButton [rounded]="true" color="primary" type="button"
                    (click)="addTransformStep()">Add transform step
            </button>
            <button class="ml-2" size="sm" fzButton [rounded]="true" color="primary" type="button"
                    (click)="addFilterStep()">Add filter step
            </button>
        </div>
    </div>
    <!-- submit -->
    <div class="d-flex justify-content-start mt-5">
        <button class="mr-3" fzButton [rounded]="true" color="primary"
                [disabled]="!pipelineForm.valid" type="submit">{{edit ? 'Save' : 'Create'}}</button>
        <!-- cancel -->
        <button fzButton [rounded]="true" color="danger" type="button" (click)="location.back()">Cancel</button>
    </div>
</form>
